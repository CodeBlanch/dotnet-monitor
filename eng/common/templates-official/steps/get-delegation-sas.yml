steps:
- template: /eng/common/core-templates/steps/get-delegation-sas.yml
  parameters:
    is1ESPipeline: true

      # Temporarily work around a helix issue where SAS tokens with / in them will cause incorrect downloads
      # of correlation payloads. https://github.com/dotnet/dnceng/issues/3484
      $sas = ""
      do {
        $sas = az storage container generate-sas --account-name ${{ parameters.storageAccount }} --name ${{ parameters.container }} --permissions ${{ parameters.permissions }} --expiry $expiry --auth-mode login --as-user -o tsv
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to generate SAS token."
          exit 1
        }
      } while($sas.IndexOf('/') -ne -1)

      if ($LASTEXITCODE -ne 0) {
        Write-Error "Failed to generate SAS token."
        exit 1
      }

      if ('${{ parameters.base64Encode }}' -eq 'true') {
        $sas = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($sas))
      }

      Write-Host "Setting '${{ parameters.outputVariableName }}' with the access token value"
      Write-Host "##vso[task.setvariable variable=${{ parameters.outputVariableName }};issecret=true]$sas"
